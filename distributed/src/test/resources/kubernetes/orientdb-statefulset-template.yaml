apiVersion: v1
kind: Service
metadata:
  name: orientdb
  labels:
    app: orientdb
spec:
  ports:
  - port: 2480
    name: http
  - port: 2424
    name: binary
  - port: 2434
    name: hazelcast
  clusterIP: None
  selector:
    app: orientdb
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: orientdb
spec:
  selector:
    matchLabels:
      app: orientdb
  replicas: 1
  serviceName: orientdb
  template:
    metadata:
      labels:
        app: orientdb
        orientdb-cluster-member: "true"
    spec:
      terminationGracePeriodSeconds: 10
      containers:
        - args:
            - dserver.sh
          name: orientdb
          image: 192.168.2.119:5000/pxsalehi/orientdb:3.1.1
          imagePullPolicy: Always
          env:
            - name: ENABLE_KUBERNETES_DISCOVERY
              value: "true"
            - name: ORIENTDB_NODE_NAME
              value: orientdb-eu-0
          ports:
            - containerPort: 2480
              protocol: TCP
            - containerPort: 2424
              protocol: TCP
            - containerPort: 2434
              protocol: TCP
          volumeMounts:
            - name: databases
              mountPath: /orientdb/databases
            - name: config
              mountPath: /orientdb/config
      initContainers:
        - name: copy-configs
          image: busybox:1.31
          command: ['sh', '-c']
          args:
            - cp -v /orientdb-config/* /orientdb/config/
          volumeMounts:
            - name: config
              mountPath: /orientdb/config
            - name: orientdb-configmap
              mountPath: /orientdb-config
#            - name: server-configmap
#              mountPath: /orientdb-config/server
#            - name: hazelcast-configmap
#              mountPath: /orientdb-config/hazelcast
#            - name: distributed-db-configmap
#              mountPath: /orientdb-config/distributed
      volumes:
        - name: orientdb-configmap
          configMap:
            name: orientdb-config
#        - name: server-configmap
#          configMap:
#            name: orientdb-server-config
#            items:
#            - key: orientdb-server-config.xml
#              path: orientdb-server-config.xml
#        - name: hazelcast-configmap
#          configMap:
#            name: hazelcast-config
#            items:
#              - key: hazelcast.xml
#                path: hazelcast.xml
#        - name: distributed-db-configmap
#          configMap:
#            name: default-distributed-db-config
#            items:
  volumeClaimTemplates:
    - metadata:
        name: databases
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 2Gi
    - metadata:
        name: config
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi